{"version":3,"sources":["../../../src/lib/consistentObservable.js"],"names":["defaultEquals","x","y","IndependentObservable","value","_value","_baseChanged","baseChanged","pub","_transitionEnded","transitionEnded","_transitionEndedHandler","_handleTransitionEnd","bind","newValue","transition","Error","isEmpty","ended","addHandler","fire","newIndependent","ROWrapper","baseObservable","_baseObservable","_baseChangedHandler","peek","equals","newROWrapper","addROWrapper","Action","action","cleanup","runAutomatically","_cleanup","_action","_runAutomatically","_hasBaseChanged","_handleDependencyBaseChanged","_startListeningForTransitionEnd","_dependencyInfos","Map","_recordHandler","_record","_clean","_invalidated","_runAfterLastTransition","_runTwiceAfterLastTransition","run","_close","dependency","dependencyInfo","equalss","size","delete","_hasDependencyChanged","isFinal","removeHandler","clear","_enableBaseChanged","keys","currentValue","_hasSingleDependencyChanged","get","Set","set","add","newAction","ComputedObservable","calculation","recorder","_calculation","update","newComputed","newTransition","transitionEndedPub","inTransition","operation","parentTransition","result","isObservable","observable"],"mappings":"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","file":"consistentObservable.js","sourcesContent":["import { newOneTimeEvent } from 'one-time-event';\n\nexport const defaultEquals = (x, y) => {\n  return x === y;\n};\n\nexport class IndependentObservable {\n  constructor(value) {\n    this._value = value;\n    this._baseChanged = newOneTimeEvent();\n    this.baseChanged = this._baseChanged.pub;\n\n    this._transitionEnded = newOneTimeEvent();\n    this.transitionEnded = this._transitionEnded.pub;\n    this._transitionEndedHandler = this._handleTransitionEnd.bind(this);\n  }\n\n  // equals get, set\n\n  peek() {\n    return this._value;\n  }\n\n  set(newValue, transition) {\n    if (!transition) {\n      throw new Error('Can only set inside a transition.');\n    }\n    this._value = newValue;\n    if (!this._transitionEnded.isEmpty) {\n      /* [A] hidden feature: _transitionEnded\n       * is not registered in transition when handlers registered after set */\n      transition.ended.addHandler(this._transitionEndedHandler);\n    }\n    this._baseChanged.fire(this);\n  }\n\n  _handleTransitionEnd() {\n    this._transitionEnded.fire(this);\n  }\n}\n\nexport const newIndependent = (value) => {\n  return new IndependentObservable(value);\n};\n\nexport class ROWrapper {\n  constructor(baseObservable) {\n    this._baseObservable = baseObservable;\n\n    this._baseChanged = newOneTimeEvent(() =>\n      this._baseObservable.baseChanged.addHandler(this._baseChangedHandler));\n    this._baseChangedHandler =\n      this._baseChanged.fire.bind(this._baseChanged, this);\n    this.baseChanged = this._baseChanged.pub;\n\n    this._transitionEnded = newOneTimeEvent(() =>\n      this._baseObservable.transitionEnded.addHandler(\n        this._transitionEndedHandler));\n    this._transitionEndedHandler =\n      this._transitionEnded.fire.bind(this._transitionEnded, this);\n    this.transitionEnded = this._transitionEnded.pub;\n  }\n\n  get equals() { return this._baseObservable.equals; }\n\n  peek() { return this._baseObservable.peek(); }\n}\n\nexport const newROWrapper = (baseObservable) => {\n  return new ROWrapper(baseObservable);\n};\n\nexport const addROWrapper = (baseObservable) => {\n  baseObservable.pub = new ROWrapper(baseObservable);\n  return baseObservable;\n};\n\nexport class Action {\n  constructor(\n      action /* (recorder) */,\n      cleanup /* (isFinal) */,\n      runAutomatically = true) {\n    this._cleanup = cleanup;\n    this._action = action;\n    this._runAutomatically = runAutomatically;\n\n    this._baseChanged = newOneTimeEvent();\n    // invoked, when any dependency in the computation graph changes\n    this.baseChanged = this._baseChanged.pub;\n    this._hasBaseChanged = true;\n    this._baseChangedHandler = this._handleDependencyBaseChanged.bind(this);\n\n    this._transitionEnded = newOneTimeEvent(\n        this._startListeningForTransitionEnd.bind(this));\n    this._transitionEndedHandler = this._handleTransitionEnd.bind(this);\n    this.transitionEnded = this._transitionEnded.pub;\n\n    this._dependencyInfos = new Map(); // dependency → dependencyInfo\n\n    this._recordHandler = this._record.bind(this);\n\n    this._clean = true;\n\n    this._invalidated = false;\n\n    this._runAfterLastTransition = false;\n    this._runTwiceAfterLastTransition = false;\n\n    if (this._runAutomatically) {\n      this.run();\n    }\n  }\n\n  run() {\n    if (this._runAfterLastTransition) {\n      this._runTwiceAfterLastTransition = true;\n    } else {\n      this._runAfterLastTransition = true;\n    }\n    this._close(false);\n    this._action(this._recordHandler);\n    this._clean = false;\n    this._invalidated = false;\n    this._hasBaseChanged = false;\n    for (const [dependency, dependencyInfo] of this._dependencyInfos) {\n      if (dependencyInfo.equalss.size === 0) {\n        this._dependencyInfos.delete(dependency);\n      }\n    }\n  }\n\n  /* runs the action,\n   * if its computation is not in concert with its dependencies */\n  update() {\n    if (!this._hasBaseChanged) {\n      return false;\n    }\n    if (this._invalidated || this._clean || this._hasDependencyChanged()) {\n      this.run();\n      return true;\n    }\n    this._hasBaseChanged = false;\n    return false;\n  }\n\n  close() {\n    this._close(true);\n  }\n\n  _close(isFinal) {\n    if (!this._clean) {\n      this._hasBaseChanged = true;\n      for (const [dependency, dependencyInfo] of this._dependencyInfos) {\n        dependency.baseChanged.removeHandler(this._baseChangedHandler);\n        dependency.transitionEnded.removeHandler(this._transitionEndedHandler);\n        dependencyInfo.equalss.clear();\n      }\n      if (this._cleanup) {\n        this._cleanup(isFinal);\n      }\n      this._clean = true;\n    }\n  }\n\n  // say that a not recorded dependency has changed\n  invalidate(transition) {\n    if (!transition) {\n      throw new Error('Can only invalidate inside a transition.');\n    }\n    this._invalidated = true;\n    // see [A]\n    if (!this._transitionEnded.isEmpty) {\n      transition.ended.addHandler(this._transitionEndedHandler);\n    }\n    this._enableBaseChanged();\n  }\n\n  _startListeningForTransitionEnd() {\n    if (!this._clean) {\n      for (const dependency of this._dependencyInfos.keys()) {\n        dependency.transitionEnded.addHandler(this._transitionEndedHandler);\n      }\n    }\n  }\n\n  _hasDependencyChanged() {\n    for (const [dependency, dependencyInfo] of this._dependencyInfos) {\n      if (dependencyInfo.baseChanged) {\n        const currentValue = dependency.peek();\n        if (Action._hasSingleDependencyChanged(dependencyInfo, currentValue)) {\n          return true;\n        }\n        dependency.baseChanged.addHandler(this._baseChangedHandler);\n      }\n    }\n    return false;\n  }\n\n  _handleDependencyBaseChanged(dependency) {\n    const dependencyInfo = this._dependencyInfos.get(dependency);\n    dependencyInfo.baseChanged = true;\n    this._enableBaseChanged();\n  }\n\n  _enableBaseChanged() {\n    if (!this._hasBaseChanged) {\n      this._hasBaseChanged = true;\n      this._baseChanged.fire(this);\n    }\n  }\n\n  _handleTransitionEnd(dependency) {\n    if (dependency) {\n      const dependencyInfo = this._dependencyInfos.get(dependency);\n      const currentValue = dependency.peek();\n      if (!this._runTwiceAfterLastTransition &&\n          !Action._hasSingleDependencyChanged(dependencyInfo, currentValue)) {\n        dependencyInfo.baseChanged = false;\n        dependency.baseChanged.addHandler(this._baseChangedHandler);\n        dependency.transitionEnded.addHandler(this._transitionEndedHandler);\n        return;\n      }\n    }\n    this._runAfterLastTransition = false;\n    this._runTwiceAfterLastTransition = false;\n    if (this._runAutomatically) {\n      this.run();\n    }\n    this._transitionEnded.fire(this);\n  }\n\n  _record(dependency, equals) {\n    equals = equals || dependency.equals || defaultEquals;\n    let dependencyInfo = this._dependencyInfos.get(dependency);\n    if (!dependencyInfo) {\n      dependencyInfo = {\n        equalss: new Set(),\n        baseChanged: false\n      };\n      this._dependencyInfos.set(dependency, dependencyInfo);\n    }\n    if (dependencyInfo.equalss.size === 0) {\n      dependency.baseChanged.addHandler(this._baseChangedHandler);\n      if (this._runAutomatically || !this._transitionEnded.isEmpty) {\n        dependency.transitionEnded.addHandler(this._transitionEndedHandler);\n      }\n      dependencyInfo.value = dependency.peek();\n    }\n    dependencyInfo.equalss.add(equals);\n    return dependencyInfo.value;\n  }\n\n  static _hasSingleDependencyChanged(dependencyInfo, currentValue) {\n    for (const equals of dependencyInfo.equalss) {\n      if (!equals(dependencyInfo.value, currentValue)) {\n        return true;\n      }\n    }\n    return false;\n  }\n}\n\nexport const newAction = (action, cleanup, runAutomatically) => {\n  return new Action(action, cleanup, runAutomatically);\n};\n\nexport class ComputedObservable extends Action {\n  constructor(calculation, cleanup) {\n    super((recorder) => {\n      this._value = this._calculation(recorder);\n    }, cleanup, false);\n    this._calculation = calculation;\n  }\n\n  // equals get, set\n\n  peek() {\n    this.update();\n    return this._value;\n  }\n}\n\nexport const newComputed = (calculation, cleanup) => {\n  return new ComputedObservable(calculation, cleanup);\n};\n\nexport const newTransition = (transitionEndedPub) => {\n  return {\n    ended: transitionEndedPub\n  };\n};\n\nexport const inTransition = (operation, parentTransition) => {\n  if (parentTransition) {\n    return operation(parentTransition);\n  }\n\n  const transitionEnded = newOneTimeEvent();\n  const transition = newTransition(transitionEnded.pub);\n\n  let result;\n  try {\n    result = operation(transition);\n  } finally {\n    transitionEnded.fire();\n  }\n  return result;\n};\n\nexport const isObservable = (observable) => {\n  return observable && observable.transitionEnded &&\n      observable.peek && observable.baseChanged;\n};\n"]}